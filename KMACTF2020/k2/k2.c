#include <stdio.h>
#include <stdlib.h>

typedef void print(long a);

typedef struct abc{
	char* a;
	print* abcf;
}abc;
void  timeout(){
  puts("Times Up!");
  exit(0);
}
void abcprint(long a){
	printf("\nmessager:\n");
	printf("%s\n",*(long*)(a));
	printf("> ");
	fflush(stdout);
	
}
int abcc[300]; //???
abc *ga[256];
int ab[200]; //???
int count=1;
void cread(char*a,int l ){
	int n=read(0,a,l);
	if(n==-1)
		{puts("error read");
		fflush(stdout);}
	else
		a[n]=0;
}
void add(){
	if(count>255){
		puts("max");
		return;
	}
	char aa[16];
	abc *a = (abc*)malloc(8);
	puts("nhap strlen:");
	fflush(stdout);
	cread(&aa,15);
	a->a = (char*)malloc(atoi(aa));
	puts("nhap str:");
	fflush(stdout);
	cread(a->a,atoi(aa));
	a->abcf = (print*)(long)abcprint;
	
	ga[count]=a;
	printf("index:%d\n",count);
	fflush(stdout);
	count++;

}
void doview(void *arg){ 	
	int i=*(int*)(arg+4);
	if (i <= 0)
		return 0;
	abc *a=ga[i];
	if (a==0){
		puts("error out bound\n>");
		fflush(stdout);
		return;
	}
	a->abcf((long)a);
	return 0;
}
void view(){
	int *arg = malloc(sizeof(*arg)*2);
	char aa[16];
	*arg = 0;
	puts("view index:");
	fflush(stdout);
	cread(&aa,15);
	*(arg+1) = atoi(aa);
	doview((void*)arg);
}
void delete(){
	puts("delete index:");
	fflush(stdout);
	char aa[16];
	cread(&aa,15);
	int z=1;
	if(strchr(aa,'a')){
			while(z<count){
			free(ga[z]->a);
			free(ga[z]);
			z++;
			}
		return;
	}
	else{
		z=atoi(aa);
		free(ga[z]->a);
		free(ga[z]);
		while(z<count){
			ga[z]=ga[z+1];
			z++;
		}
		ga[z+1]=0;
	}
		//count-=1;
}
main(){
	char aa[16];
	setbuf(stdin, 0);
	setbuf(stdout, 0);
	setbuf(stderr, 0);
	memset(ga,0,256*4);
	signal(14, timeout);
	alarm(15);
	while (1){
		printf("> ");
		fflush(stdout);
		cread(&aa,15);
		switch(atoi(aa))	{
			case 1:
				add();
				break;
			case 2:
				view();
				break;
			case 3:
				delete();
				break;
			case 4:
				return 0;
				break;
			default:
				break;
		}
	}
	return 0;
}
